import{s as E}from"./index-laD0T8Yw.js";import{a as $,g as K}from"./useEffectiveOwner-BN9vJCNM.js";const N=(_,p,l,m)=>{const y=(l-_)*Math.PI/180,w=(m-p)*Math.PI/180,S=Math.sin(y/2)*Math.sin(y/2)+Math.cos(_*Math.PI/180)*Math.cos(l*Math.PI/180)*Math.sin(w/2)*Math.sin(w/2);return 3959*(2*Math.atan2(Math.sqrt(S),Math.sqrt(1-S)))},B={},Y=async _=>B[_]?B[_]:(console.warn("Google Maps API key not configured"),B[_]=null,null),Z=async(_,p=10)=>{const l={},m=[...new Set(_.filter(Boolean))],d=[];for(const y of m)B[y]?l[y]=B[y]:d.push(y);if(d.length===0)return l;for(let y=0;y<d.length;y+=p){const w=d.slice(y,y+p),S=await Promise.all(w.map(x=>Y(x)));w.forEach((x,O)=>{S[O]&&(l[x]=S[O])})}return l},X={async getAll(_,p={}){const{status:l,limit:m=50,offset:d=0}=p;let y=E.from("mass_email_batches").select(`
        *,
        template:email_templates(id, name, subject)
      `).order("created_at",{ascending:!1}).range(d,d+m-1);y=$(y,_),l&&(y=y.eq("status",l));const{data:w,error:S}=await y;if(S)throw S;return w},async getById(_,p){let l=E.from("mass_email_batches").select(`
        *,
        template:email_templates(*)
      `).eq("id",p);l=$(l,_);const{data:m,error:d}=await l.single();if(d)throw d;return m},async create(_,p){const l=K(_),{data:m,error:d}=await E.from("mass_email_batches").insert({owner_id:l,status:"Draft",...p}).select().single();if(d)throw d;return m},async update(_,p,l){let m=E.from("mass_email_batches").update({...l,updated_at:new Date().toISOString()}).eq("id",p);m=$(m,_);const{data:d,error:y}=await m.select().single();if(y)throw y;return d},async delete(_,p){let l=E.from("mass_email_batches").delete().eq("id",p).eq("status","Draft");l=$(l,_);const{error:m}=await l;if(m)throw m;return!0},async getRecipients(_,p,l={}){const{limit:m=100,offset:d=0}=l,{rules:y=[],groups:w=[],notOptedOut:S=!0,search:x=""}=p||{};let O=w.length>0?w:y.length>0?[{rules:y}]:[];const M=Array.isArray(_)?_:[_];let I=E.from("accounts").select("account_unique_id, name, person_email, email, account_status, primary_contact_first_name, primary_contact_last_name, person_has_opted_out_of_email, billing_city, billing_state, billing_postal_code, billing_street, created_at").in("owner_id",M);S&&(I=I.or("person_has_opted_out_of_email.is.null,person_has_opted_out_of_email.eq.false")),x&&(I=I.or(`name.ilike.%${x}%,person_email.ilike.%${x}%,email.ilike.%${x}%`)),O.length===0?I=I.order("name").range(d,d+m-1):I=I.order("name").limit(1e4);const{data:A,error:P}=await I;if(P)throw P;let L=A.filter(u=>{const h=u.person_email||u.email;return h&&h.includes("@")});if(O.length===0)return L;const C=O.some(u=>(u.rules||[]).some(f=>["policy_type","active_policy_type","policy_status","policy_count","policy_expiration","policy_effective","policy_class"].includes(f.field)&&f.value));let v={};if(C&&L.length>0){const u=L.map(c=>c.account_unique_id),{data:h,error:f}=await E.from("policies").select("account_id, policy_lob, expiration_date, effective_date, policy_status").in("account_id",u);if(f)throw f;h.forEach(c=>{v[c.account_id]||(v[c.account_id]=[]),v[c.account_id].push(c)})}let T={};if(L.length>0){const u=L.map(c=>c.account_unique_id),{data:h,error:f}=await E.from("email_logs").select("account_id, sent_at").in("account_id",u).eq("status","sent").order("sent_at",{ascending:!1});if(f)throw f;h==null||h.forEach(c=>{!T[c.account_id]&&c.sent_at&&(T[c.account_id]=c.sent_at)})}const g=O.some(u=>(u.rules||[]).some(f=>f.field==="location"&&f.value));let b={};if(g&&L.length>0){const u={};L.forEach(f=>{const c=(f.billing_postal_code||"").trim(),t=(f.billing_city||"").trim(),o=(f.billing_state||"").trim();let D="";c&&o?D=`${c}, ${o}, USA`:t&&o?D=`${t}, ${o}, USA`:c&&(D=`${c}, USA`),D&&(u[f.account_unique_id]=D)});const h=[...new Set(Object.values(u))];b=await Z(h),L.forEach(f=>{f._locationKey=u[f.account_unique_id]})}const k=(u,h,f)=>{const{field:c,operator:t,value:o,value2:D,radius:R}=h;if(!c||!t||!["is_empty","is_not_empty"].includes(t)&&!o)return!0;switch(c){case"account_status":{const i=(u.account_status||"").toLowerCase();return t==="is"?i===o.toLowerCase():t==="is_not"?i!==o.toLowerCase():t==="is_any"?o.split(",").map(e=>e.toLowerCase()).includes(i):t==="is_not_any"?!o.split(",").map(e=>e.toLowerCase()).includes(i):!0}case"policy_type":{const i=["is_any","is_not_any"].includes(t)?o.split(","):[o],r=f.some(e=>i.some(a=>{var s;return(s=e.policy_lob)==null?void 0:s.toLowerCase().includes(a.toLowerCase())}));return t==="is"||t==="is_any"?r:t==="is_not"||t==="is_not_any"?!r:!0}case"active_policy_type":{const i=["is_any","is_not_any"].includes(t)?o.split(","):[o],e=f.filter(a=>{var n;return((n=a.policy_status)==null?void 0:n.toLowerCase().trim())==="active"}).some(a=>i.some(s=>{var n;return(n=a.policy_lob)==null?void 0:n.toLowerCase().includes(s.toLowerCase())}));return t==="is"||t==="is_any"?e:t==="is_not"||t==="is_not_any"?!e:!0}case"policy_status":{const i=["is_any","is_not_any"].includes(t)?o.split(","):[o],r=f.some(e=>i.some(a=>{var s;return((s=e.policy_status)==null?void 0:s.toLowerCase())===a.toLowerCase()}));return t==="is"||t==="is_any"?r:t==="is_not"||t==="is_not_any"?!r:!0}case"policy_class":{const i=["is_any","is_not_any"].includes(t)?o.split(","):[o],r=f.some(e=>i.some(a=>{var s;return((s=e.policy_class)==null?void 0:s.toLowerCase())===a.toLowerCase()}));return t==="is"||t==="is_any"?r:t==="is_not"||t==="is_not_any"?!r:!0}case"policy_count":{const i=f.length,r=parseInt(o,10),e=D?parseInt(D,10):r;return t==="equals"?i===r:t==="greater_than"?i>r:t==="less_than"?i<r:t==="at_least"?i>=r:t==="at_most"?i<=r:t==="between"?i>=r&&i<=e:!0}case"policy_expiration":{const i=f.filter(e=>{var a;return((a=e.policy_status)==null?void 0:a.toLowerCase().trim())==="active"}),r=new Date().toISOString().split("T")[0];if(t==="in_next_days"){const e=parseInt(o,10),a=new Date;a.setDate(a.getDate()+e);const s=a.toISOString().split("T")[0];return i.some(n=>n.expiration_date&&n.expiration_date>=r&&n.expiration_date<=s)}if(t==="in_last_days"){const e=parseInt(o,10),a=new Date;a.setDate(a.getDate()-e);const s=a.toISOString().split("T")[0];return i.some(n=>n.expiration_date&&n.expiration_date>=s&&n.expiration_date<=r)}if(t==="more_than_days_future"){const e=parseInt(o,10),a=new Date;a.setDate(a.getDate()+e);const s=a.toISOString().split("T")[0];return i.some(n=>n.expiration_date&&n.expiration_date>s)}if(t==="less_than_days_future"){const e=parseInt(o,10),a=new Date;a.setDate(a.getDate()+e);const s=a.toISOString().split("T")[0];return i.some(n=>n.expiration_date&&n.expiration_date>=r&&n.expiration_date<s)}if(t==="more_than_days_ago"){const e=parseInt(o,10),a=new Date;a.setDate(a.getDate()-e);const s=a.toISOString().split("T")[0];return i.some(n=>n.expiration_date&&n.expiration_date<s)}if(t==="less_than_days_ago"){const e=parseInt(o,10),a=new Date;a.setDate(a.getDate()-e);const s=a.toISOString().split("T")[0];return i.some(n=>n.expiration_date&&n.expiration_date>=s&&n.expiration_date<=r)}if(t==="exactly_days_future"){const e=parseInt(o,10),a=new Date;a.setDate(a.getDate()+e);const s=a.toISOString().split("T")[0];return i.some(n=>n.expiration_date===s)}if(t==="exactly_days_ago"){const e=parseInt(o,10),a=new Date;a.setDate(a.getDate()-e);const s=a.toISOString().split("T")[0];return i.some(n=>n.expiration_date===s)}return t==="before"?i.some(e=>e.expiration_date&&e.expiration_date<o):t==="after"?i.some(e=>e.expiration_date&&e.expiration_date>o):t==="between"?i.some(e=>e.expiration_date&&e.expiration_date>=o&&e.expiration_date<=(D||o)):!0}case"policy_effective":{const i=f.filter(e=>{var a;return((a=e.policy_status)==null?void 0:a.toLowerCase().trim())==="active"}),r=new Date().toISOString().split("T")[0];if(t==="in_next_days"){const e=parseInt(o,10),a=new Date;a.setDate(a.getDate()+e);const s=a.toISOString().split("T")[0];return i.some(n=>n.effective_date&&n.effective_date>=r&&n.effective_date<=s)}if(t==="in_last_days"){const e=parseInt(o,10),a=new Date;a.setDate(a.getDate()-e);const s=a.toISOString().split("T")[0];return i.some(n=>n.effective_date&&n.effective_date>=s&&n.effective_date<=r)}if(t==="more_than_days_future"){const e=parseInt(o,10),a=new Date;a.setDate(a.getDate()+e);const s=a.toISOString().split("T")[0];return i.some(n=>n.effective_date&&n.effective_date>s)}if(t==="less_than_days_future"){const e=parseInt(o,10),a=new Date;a.setDate(a.getDate()+e);const s=a.toISOString().split("T")[0];return i.some(n=>n.effective_date&&n.effective_date>=r&&n.effective_date<s)}if(t==="more_than_days_ago"){const e=parseInt(o,10),a=new Date;a.setDate(a.getDate()-e);const s=a.toISOString().split("T")[0];return i.some(n=>n.effective_date&&n.effective_date<s)}if(t==="less_than_days_ago"){const e=parseInt(o,10),a=new Date;a.setDate(a.getDate()-e);const s=a.toISOString().split("T")[0];return i.some(n=>n.effective_date&&n.effective_date>=s&&n.effective_date<=r)}if(t==="exactly_days_future"){const e=parseInt(o,10),a=new Date;a.setDate(a.getDate()+e);const s=a.toISOString().split("T")[0];return i.some(n=>n.effective_date===s)}if(t==="exactly_days_ago"){const e=parseInt(o,10),a=new Date;a.setDate(a.getDate()-e);const s=a.toISOString().split("T")[0];return i.some(n=>n.effective_date===s)}return t==="before"?i.some(e=>e.effective_date&&e.effective_date<o):t==="after"?i.some(e=>e.effective_date&&e.effective_date>o):t==="between"?i.some(e=>e.effective_date&&e.effective_date>=o&&e.effective_date<=(D||o)):!0}case"state":{const i=(u.billing_state||"").toUpperCase();return t==="is"?i===o.toUpperCase():t==="is_not"?i!==o.toUpperCase():t==="is_any"?o.split(",").map(e=>e.toUpperCase()).includes(i):t==="is_not_any"?!o.split(",").map(e=>e.toUpperCase()).includes(i):!0}case"city":{const i=(u.billing_city||"").toLowerCase(),r=(o||"").toLowerCase();return t==="contains"?i.includes(r):t==="not_contains"?!i.includes(r):t==="equals"?i===r:t==="not_equals"?i!==r:t==="starts_with"?i.startsWith(r):t==="ends_with"?i.endsWith(r):t==="is_empty"?i.trim()==="":t==="is_not_empty"?i.trim()!=="":!0}case"zip_code":{const i=(u.billing_postal_code||"").toLowerCase().trim(),r=(o||"").toLowerCase().trim();return t==="contains"?i.includes(r):t==="not_contains"?!i.includes(r):t==="equals"?i===r:t==="not_equals"?i!==r:t==="starts_with"?i.startsWith(r):t==="ends_with"?i.endsWith(r):t==="is_empty"?i==="":t==="is_not_empty"?i!=="":!0}case"email_domain":{const i=(u.person_email||u.email||"").toLowerCase(),r=i.includes("@")?i.split("@")[1]:"",e=(o||"").toLowerCase().trim();return t==="contains"?r.includes(e):t==="not_contains"?!r.includes(e):t==="equals"?r===e:t==="not_equals"?r!==e:t==="starts_with"?r.startsWith(e):t==="ends_with"?r.endsWith(e):t==="is_empty"?r==="":t==="is_not_empty"?r!=="":!0}case"location":{if(t!=="within_radius"||!o)return!0;const[i,r]=o.split(",").map(parseFloat),e=parseInt(R||"25",10),a=u._locationKey;if(!a)return!1;const s=b[a];return s?N(i,r,s.lat,s.lng)<=e:!1}case"last_email_sent":{const i=T[u.account_unique_id],r=new Date().toISOString().split("T")[0];if(!i)return t==="before"?!0:t==="in_last_days"||t==="less_than_days_ago"?!1:t==="more_than_days_ago"?!0:!(t==="in_next_days"||t==="more_than_days_future"||t==="less_than_days_future"||t==="after"||t==="between");const e=i.split("T")[0];if(t==="in_last_days"){const a=parseInt(o,10),s=new Date;s.setDate(s.getDate()-a);const n=s.toISOString().split("T")[0];return e>=n&&e<=r}if(t==="more_than_days_ago"){const a=parseInt(o,10),s=new Date;s.setDate(s.getDate()-a);const n=s.toISOString().split("T")[0];return e<n}if(t==="less_than_days_ago"){const a=parseInt(o,10),s=new Date;s.setDate(s.getDate()-a);const n=s.toISOString().split("T")[0];return e>=n&&e<=r}return t==="before"?e<o:t==="after"?e>o:t==="between"?e>=o&&e<=(D||o):!0}case"account_created":{const i=u.created_at;if(!i)return!1;const r=i.split("T")[0],e=new Date().toISOString().split("T")[0];if(t==="in_next_days"||t==="more_than_days_future"||t==="less_than_days_future")return!1;if(t==="in_last_days"){const a=parseInt(o,10),s=new Date;s.setDate(s.getDate()-a);const n=s.toISOString().split("T")[0];return r>=n&&r<=e}if(t==="more_than_days_ago"){const a=parseInt(o,10),s=new Date;s.setDate(s.getDate()-a);const n=s.toISOString().split("T")[0];return r<n}if(t==="less_than_days_ago"){const a=parseInt(o,10),s=new Date;s.setDate(s.getDate()-a);const n=s.toISOString().split("T")[0];return r>=n&&r<=e}return t==="before"?r<o:t==="after"?r>o:t==="between"?r>=o&&r<=(D||o):!0}default:return!0}},U=(u,h)=>{var R,q,i;const{field:f,operator:c,value:t,value2:o}=h,D=new Date().toISOString().split("T")[0];switch(f){case"active_policy_type":{if(((R=u.policy_status)==null?void 0:R.toLowerCase().trim())!=="active")return!1;const a=(["is_any","is_not_any"].includes(c)?t.split(","):[t]).some(s=>{var n;return(n=u.policy_lob)==null?void 0:n.toLowerCase().includes(s.toLowerCase())});return c==="is"||c==="is_any"?a:c==="is_not"||c==="is_not_any"?!a:!0}case"policy_type":{const e=(["is_any","is_not_any"].includes(c)?t.split(","):[t]).some(a=>{var s;return(s=u.policy_lob)==null?void 0:s.toLowerCase().includes(a.toLowerCase())});return c==="is"||c==="is_any"?e:c==="is_not"||c==="is_not_any"?!e:!0}case"policy_status":{const e=(["is_any","is_not_any"].includes(c)?t.split(","):[t]).some(a=>{var s;return((s=u.policy_status)==null?void 0:s.toLowerCase())===a.toLowerCase()});return c==="is"||c==="is_any"?e:c==="is_not"||c==="is_not_any"?!e:!0}case"policy_class":{const e=(["is_any","is_not_any"].includes(c)?t.split(","):[t]).some(a=>{var s;return((s=u.policy_class)==null?void 0:s.toLowerCase())===a.toLowerCase()});return c==="is"||c==="is_any"?e:c==="is_not"||c==="is_not_any"?!e:!0}case"policy_expiration":{if(((q=u.policy_status)==null?void 0:q.toLowerCase().trim())!=="active")return!1;const e=u.expiration_date;if(!e)return!1;if(c==="in_next_days"){const a=parseInt(t,10),s=new Date;s.setDate(s.getDate()+a);const n=s.toISOString().split("T")[0];return e>=D&&e<=n}if(c==="in_last_days"){const a=parseInt(t,10),s=new Date;s.setDate(s.getDate()-a);const n=s.toISOString().split("T")[0];return e>=n&&e<=D}if(c==="more_than_days_future"){const a=parseInt(t,10),s=new Date;s.setDate(s.getDate()+a);const n=s.toISOString().split("T")[0];return e>n}if(c==="less_than_days_future"){const a=parseInt(t,10),s=new Date;s.setDate(s.getDate()+a);const n=s.toISOString().split("T")[0];return e>=D&&e<n}if(c==="more_than_days_ago"){const a=parseInt(t,10),s=new Date;s.setDate(s.getDate()-a);const n=s.toISOString().split("T")[0];return e<n}if(c==="less_than_days_ago"){const a=parseInt(t,10),s=new Date;s.setDate(s.getDate()-a);const n=s.toISOString().split("T")[0];return e>=n&&e<=D}if(c==="exactly_days_future"){const a=parseInt(t,10),s=new Date;s.setDate(s.getDate()+a);const n=s.toISOString().split("T")[0];return e===n}if(c==="exactly_days_ago"){const a=parseInt(t,10),s=new Date;s.setDate(s.getDate()-a);const n=s.toISOString().split("T")[0];return e===n}return c==="before"?e<t:c==="after"?e>t:c==="between"?e>=t&&e<=(o||t):!0}case"policy_effective":{if(((i=u.policy_status)==null?void 0:i.toLowerCase().trim())!=="active")return!1;const e=u.effective_date;if(!e)return!1;if(c==="in_next_days"){const a=parseInt(t,10),s=new Date;s.setDate(s.getDate()+a);const n=s.toISOString().split("T")[0];return e>=D&&e<=n}if(c==="in_last_days"){const a=parseInt(t,10),s=new Date;s.setDate(s.getDate()-a);const n=s.toISOString().split("T")[0];return e>=n&&e<=D}if(c==="more_than_days_future"){const a=parseInt(t,10),s=new Date;s.setDate(s.getDate()+a);const n=s.toISOString().split("T")[0];return e>n}if(c==="less_than_days_future"){const a=parseInt(t,10),s=new Date;s.setDate(s.getDate()+a);const n=s.toISOString().split("T")[0];return e>=D&&e<n}if(c==="more_than_days_ago"){const a=parseInt(t,10),s=new Date;s.setDate(s.getDate()-a);const n=s.toISOString().split("T")[0];return e<n}if(c==="less_than_days_ago"){const a=parseInt(t,10),s=new Date;s.setDate(s.getDate()-a);const n=s.toISOString().split("T")[0];return e>=n&&e<=D}if(c==="exactly_days_future"){const a=parseInt(t,10),s=new Date;s.setDate(s.getDate()+a);const n=s.toISOString().split("T")[0];return e===n}if(c==="exactly_days_ago"){const a=parseInt(t,10),s=new Date;s.setDate(s.getDate()-a);const n=s.toISOString().split("T")[0];return e===n}return c==="before"?e<t:c==="after"?e>t:c==="between"?e>=t&&e<=(o||t):!0}default:return!0}},W=["active_policy_type","policy_type","policy_status","policy_class","policy_expiration","policy_effective"],F=u=>["is_not","is_not_any"].includes(u.operator),V=(u,h)=>{const{field:f,operator:c,value:t}=h,o=["is_any","is_not_any"].includes(c)?t.split(","):[t];return f==="active_policy_type"?!u.filter(q=>{var i;return((i=q.policy_status)==null?void 0:i.toLowerCase().trim())==="active"}).some(q=>o.some(i=>{var r;return(r=q.policy_lob)==null?void 0:r.toLowerCase().includes(i.toLowerCase())})):f==="policy_type"?!u.some(R=>o.some(q=>{var i;return(i=R.policy_lob)==null?void 0:i.toLowerCase().includes(q.toLowerCase())})):f==="policy_status"?!u.some(R=>o.some(q=>{var i;return((i=R.policy_status)==null?void 0:i.toLowerCase())===q.toLowerCase()})):f==="policy_class"?!u.some(R=>o.some(q=>{var i;return((i=R.policy_class)==null?void 0:i.toLowerCase())===q.toLowerCase()})):!0},z=(u,h)=>{const f=h.rules||[];if(f.length===0)return!0;const c=v[u.account_unique_id]||[],t=f.filter(r=>W.includes(r.field)&&r.operator&&r.value&&!F(r)),o=f.filter(r=>W.includes(r.field)&&r.operator&&r.value&&F(r));return!f.filter(r=>!W.includes(r.field)||!r.operator||!r.value).every(r=>k(u,r,c))||!o.every(r=>V(c,r))?!1:t.length===0?!0:c.some(r=>t.every(e=>U(r,e)))},G=new Set,j=[];for(const u of L){const h=[];O.forEach((f,c)=>{z(u,f)&&h.push(c)}),h.length>0&&!G.has(u.account_unique_id)&&(G.add(u.account_unique_id),j.push({...u,_matchedGroups:h,_lastEmailSent:T[u.account_unique_id]||null}))}return j.slice(d,d+m)},async getRecipientStats(_,p){const{rules:l=[],groups:m=[],notOptedOut:d=!0,search:y=""}=p||{},w=m.length>0?m:l.length>0?[{rules:l}]:[];w.length>0;const S=w.length>1,x=w.some(C=>(C.rules||[]).some(T=>["policy_type","active_policy_type","policy_status","policy_class","policy_count","policy_expiration","location","city","zip_code","email_domain"].includes(T.field)&&(T.value||["is_empty","is_not_empty"].includes(T.operator)))),O=S||x;let M,I;O?(M=await this.getRecipients(_,p,{limit:1e4}),I=M.length):(M=await this.getRecipients(_,p,{limit:1e4}),I=M.length);const A={},P=C=>C?C.toLowerCase().replace(/\b\w/g,v=>v.toUpperCase()):"";M.forEach(C=>{const v=(C.billing_state||"").trim(),T=(C.billing_city||"").trim();if(T&&v){const g=P(T),b=v.length===2?v.toUpperCase():P(v),k=`${g}, ${b}`;A[k]=(A[k]||0)+1}});const L=Object.entries(A).map(([C,v])=>({city:C,count:v})).sort((C,v)=>v.count-C.count).slice(0,10);return{count:I,breakdown:{total:M.length,byCity:L}}},async countRecipients(_,p){return(await this.getRecipientStats(_,p)).count},async getRecipientLocationBreakdown(_,p){return(await this.getRecipientStats(_,p)).breakdown},async scheduleBatch(_,p,l=null){const m=K(_),d=await this.getById(_,p);if(!d)throw new Error("Batch not found");if(d.status!=="Draft")throw new Error("Can only schedule draft batches");const y=await this.getRecipients(_,d.filter_config,{limit:1e4});if(y.length===0)throw new Error("No recipients match the filter");const w=new Set,S=[];let x=0;for(const g of y){const b=(g.person_email||g.email||"").toLowerCase().trim();b&&!w.has(b)?(w.add(b),S.push(g)):b&&x++}if(S.length===0)throw new Error("No valid recipients after deduplication");const O=new Date;O.setDate(O.getDate()-7);const M=O.toISOString();let I=new Set,A=0;if(d.template_id){const{data:g,error:b}=await E.from("email_logs").select("to_email").eq("template_id",d.template_id).gte("sent_at",M).in("status",["Sent","Delivered","Opened","Clicked"]);b?console.warn("Failed to check recent sends, proceeding without template deduplication:",b):g&&(I=new Set(g.map(k=>(k.to_email||"").toLowerCase().trim())))}const P=S.filter(g=>{const b=(g.person_email||g.email||"").toLowerCase().trim();return I.has(b)?(A++,!1):!0});if(P.length===0)throw new Error("No eligible recipients - all have received this template within the last 7 days");const L=l||new Date().toISOString(),C=P.map(g=>({owner_id:m,account_id:g.account_unique_id,template_id:d.template_id,recipient_email:g.person_email||g.email,recipient_name:g.primary_contact_first_name?`${g.primary_contact_first_name} ${g.primary_contact_last_name||""}`.trim():g.name,subject:d.subject,scheduled_for:L,status:"Pending",batch_id:p})),v=100;let T=0;for(let g=0;g<C.length;g+=v){const b=C.slice(g,g+v),{data:k,error:U}=await E.from("scheduled_emails").insert(b).select();if(U)throw U;T+=k.length}return await this.update(_,p,{status:l?"Scheduled":"Sending",total_recipients:P.length,scheduled_for:L,started_at:l?null:new Date().toISOString()}),{scheduled:T,total:P.length,duplicatesRemoved:x,recentlySentSkipped:A,scheduledFor:L}},async cancelBatch(_,p){await this.update(_,p,{status:"Cancelled"});let l=E.from("scheduled_emails").update({status:"Cancelled"}).eq("batch_id",p).eq("status","Pending");l=$(l,_);const{error:m}=await l;if(m)throw m;return!0},async getBatchStats(_,p){let l=E.from("scheduled_emails").select("status").eq("batch_id",p);l=$(l,_);const{data:m,error:d}=await l;if(d)throw d;const y={pending:0,sent:0,failed:0,cancelled:0,total:m.length};return m.forEach(w=>{const S=w.status.toLowerCase();y[S]!==void 0&&y[S]++}),y},async getAllWithStats(_,p={}){const l=await this.getAll(_,p);return await Promise.all(l.map(async d=>{if(d.status==="Draft")return{...d,stats:null};const y=await this.getBatchStats(_,d.id);return{...d,stats:y}}))}};export{X as m};
