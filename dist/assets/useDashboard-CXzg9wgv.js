import{u as p}from"./query-BgC-0ePs.js";import{s as c}from"./index-laD0T8Yw.js";import{a as d,g,u as h}from"./useEffectiveOwner-BN9vJCNM.js";import{a as f}from"./accounts-BqGB46ES.js";const y={async getAll(a,n={}){const{status:t,automationId:e,accountId:o,limit:i=50,offset:s=0,startDate:r,endDate:l}=n;let u=c.from("email_logs").select(`
        *,
        account:accounts(account_unique_id, name, person_email, primary_contact_first_name),
        template:email_templates(id, name),
        automation:automations(id, name)
      `).order("created_at",{ascending:!1}).range(s,s+i-1);u=d(u,a),t&&(u=u.eq("status",t)),e&&(u=u.eq("automation_id",e)),o&&(u=u.eq("account_id",o)),r&&(u=u.gte("sent_at",r)),l&&(u=u.lte("sent_at",l));const{data:m,error:_}=await u;if(_)throw _;return m},async getById(a,n){let t=c.from("email_logs").select(`
        *,
        account:accounts(*),
        template:email_templates(*),
        automation:automations(id, name),
        enrollment:automation_enrollments(id, status)
      `).eq("id",n);t=d(t,a);const{data:e,error:o}=await t.single();if(o)throw o;return e},async getByIdWithEvents(a,n){const t=await this.getById(a,n),{data:e,error:o}=await c.from("email_events").select("*").eq("email_log_id",n).order("event_timestamp",{ascending:!0});if(o)throw o;return{...t,events:e}},async getByAccount(a,n,t={}){const{limit:e=20}=t;let o=c.from("email_logs").select(`
        *,
        template:email_templates(id, name),
        automation:automations(id, name)
      `).eq("account_id",n).order("created_at",{ascending:!1}).limit(e);o=d(o,a);const{data:i,error:s}=await o;if(s)throw s;return i},async getByAutomation(a,n,t={}){const{limit:e=50,offset:o=0,status:i}=t;let s=c.from("email_logs").select(`
        *,
        account:accounts(account_unique_id, name, person_email)
      `).eq("automation_id",n).order("created_at",{ascending:!1}).range(o,o+e-1);s=d(s,a),i&&(s=s.eq("status",i));const{data:r,error:l}=await s;if(l)throw l;return r},async create(a,n){const t=g(a),{data:e,error:o}=await c.from("email_logs").insert({owner_id:t,status:"Queued",...n}).select().single();if(o)throw o;return e},async updateStatus(a,n,t,e={}){let o=c.from("email_logs").update({status:t,...e,updated_at:new Date().toISOString()}).eq("id",n);o=d(o,a);const{data:i,error:s}=await o.select().single();if(s)throw s;return i},async markSent(a,n,t){return this.updateStatus(a,n,"Sent",{sent_at:new Date().toISOString(),sendgrid_message_id:t})},async markFailed(a,n,t,e=null){return this.updateStatus(a,n,"Failed",{failed_at:new Date().toISOString(),error_message:t,error_code:e})},async getRecentOpens(a,n=10){let t=c.from("email_logs").select(`
        id, subject, first_opened_at, open_count,
        account:accounts(account_unique_id, name, person_email)
      `).not("first_opened_at","is",null).order("first_opened_at",{ascending:!1}).limit(n);t=d(t,a);const{data:e,error:o}=await t;if(o)throw o;return e},async getRecentClicks(a,n=10){let t=c.from("email_logs").select(`
        id, subject, first_clicked_at, click_count,
        account:accounts(account_unique_id, name, person_email)
      `).not("first_clicked_at","is",null).order("first_clicked_at",{ascending:!1}).limit(n);t=d(t,a);const{data:e,error:o}=await t;if(o)throw o;return e},async getBounces(a,n={}){const{limit:t=50,offset:e=0}=n;let o=c.from("email_logs").select(`
        *,
        account:accounts(account_unique_id, name, person_email)
      `).eq("status","Bounced").order("bounced_at",{ascending:!1}).range(e,e+t-1);o=d(o,a);const{data:i,error:s}=await o;if(s)throw s;return i},async getStats(a,n,t,e=null){const o=g(a),{data:i,error:s}=await c.rpc("get_email_stats",{p_owner_id:o,p_start_date:n,p_end_date:t,p_automation_id:e});if(s)throw s;return(i==null?void 0:i[0])||{total_sent:0,total_delivered:0,total_opened:0,unique_opens:0,total_clicked:0,unique_clicks:0,total_bounced:0,open_rate:0,click_rate:0}},async getDailyStats(a,n,t,e=null){let o=c.from("email_stats_daily").select("*").gte("stat_date",n).lte("stat_date",t).order("stat_date");o=d(o,a),e?o=o.eq("automation_id",e):o=o.is("automation_id",null);const{data:i,error:s}=await o;if(s)throw s;return i},async getComparisonStats(a,n=30){const t=new Date,e=new Date(t);e.setDate(e.getDate()-n);const o=new Date(e);o.setDate(o.getDate()-n);const[i,s]=await Promise.all([this.getStats(a,e.toISOString().split("T")[0],t.toISOString().split("T")[0]),this.getStats(a,o.toISOString().split("T")[0],e.toISOString().split("T")[0])]),r=(l,u)=>u===0?l>0?100:0:((l-u)/u*100).toFixed(1);return{current:i,previous:s,changes:{sent:r(i.total_sent,s.total_sent),delivered:r(i.total_delivered,s.total_delivered),opened:r(i.unique_opens,s.unique_opens),clicked:r(i.unique_clicks,s.unique_clicks),bounced:r(i.total_bounced,s.total_bounced)}}}},q={async getRecent(a,n={}){const{category:t,limit:e=20,offset:o=0}=n;let i=c.from("activity_log").select(`
        *,
        account:accounts(account_unique_id, name),
        automation:automations(id, name),
        email_log:email_logs(id, subject)
      `).order("created_at",{ascending:!1}).range(o,o+e-1);i=d(i,a),t&&(i=i.eq("event_category",t));const{data:s,error:r}=await i;if(r)throw r;return s},async getByAccount(a,n,t=20){let e=c.from("activity_log").select(`
        *,
        automation:automations(id, name),
        email_log:email_logs(id, subject)
      `).eq("account_id",n).order("created_at",{ascending:!1}).limit(t);e=d(e,a);const{data:o,error:i}=await e;if(i)throw i;return o},async getByAutomation(a,n,t=50){let e=c.from("activity_log").select(`
        *,
        account:accounts(account_unique_id, name)
      `).eq("automation_id",n).order("created_at",{ascending:!1}).limit(t);e=d(e,a);const{data:o,error:i}=await e;if(i)throw i;return o},async getByType(a,n,t={}){const{limit:e=50,offset:o=0}=t;let i=c.from("activity_log").select(`
        *,
        account:accounts(account_unique_id, name)
      `).eq("event_type",n).order("created_at",{ascending:!1}).range(o,o+e-1);i=d(i,a);const{data:s,error:r}=await i;if(r)throw r;return s},async log(a,n){const t=g(a),{data:e,error:o}=await c.from("activity_log").insert({owner_id:t,...n}).select().single();if(o)throw o;return e},async logEmailSent(a,n,t,e=null){return this.log(a,{event_type:"email_sent",event_category:"email",title:"Email sent",email_log_id:n,account_id:t,automation_id:e,actor_type:e?"automation":"user"})},async logEmailOpened(a,n,t){return this.log(a,{event_type:"email_opened",event_category:"email",title:"Email opened",email_log_id:n,account_id:t,actor_type:"system"})},async logEmailClicked(a,n,t,e=null){return this.log(a,{event_type:"email_clicked",event_category:"email",title:"Email link clicked",email_log_id:n,account_id:t,actor_type:"system",event_data:e?{url:e}:{}})},async logEnrollment(a,n,t,e){return this.log(a,{event_type:"enrollment_created",event_category:"automation",title:`Enrolled in ${e}`,automation_id:n,account_id:t,actor_type:"automation"})},async logAutomationCompleted(a,n,t,e){return this.log(a,{event_type:"automation_completed",event_category:"automation",title:`Completed ${e}`,automation_id:n,account_id:t,actor_type:"automation"})},async logUnsubscribe(a,n,t,e=null){return this.log(a,{event_type:"unsubscribed",event_category:"account",title:t==="all"?"Unsubscribed from all emails":"Unsubscribed from automation",account_id:n,automation_id:e,actor_type:"system",severity:"warning"})},async logBounce(a,n,t,e){return this.log(a,{event_type:"email_bounced",event_category:"email",title:`Email bounced (${e})`,email_log_id:n,account_id:t,actor_type:"system",severity:"warning",event_data:{bounce_type:e}})},async getStats(a,n=7){const t=new Date;t.setDate(t.getDate()-n);let e=c.from("activity_log").select("event_type, event_category").gte("created_at",t.toISOString());e=d(e,a);const{data:o,error:i}=await e;if(i)throw i;const s={total:o.length,byType:{},byCategory:{}};return o.forEach(r=>{s.byType[r.event_type]=(s.byType[r.event_type]||0)+1,s.byCategory[r.event_category]=(s.byCategory[r.event_category]||0)+1}),s}},S={async getAll(a,n={}){const{status:t,automationId:e,limit:o=50,offset:i=0}=n;let s=c.from("scheduled_emails").select(`
        *,
        account:accounts(account_unique_id, name, person_email),
        template:email_templates(id, name),
        automation:automations(id, name)
      `).order("scheduled_for",{ascending:!0}).range(i,i+o-1);s=d(s,a),t&&(s=s.eq("status",t)),e&&(s=s.eq("automation_id",e));const{data:r,error:l}=await s;if(l)throw l;return r},async getUpcoming(a,n=10){let t=c.from("scheduled_emails").select(`
        *,
        account:accounts(account_unique_id, name, person_email),
        automation:automations(id, name)
      `).eq("status","Pending").gte("scheduled_for",new Date().toISOString()).order("scheduled_for",{ascending:!0}).limit(n);t=d(t,a);const{data:e,error:o}=await t;if(o)throw o;return e},async getReadyToSend(){const{data:a,error:n}=await c.from("scheduled_emails").select(`
        *,
        account:accounts(*),
        template:email_templates(*),
        automation:automations(id, name, owner_id)
      `).eq("status","Pending").lte("scheduled_for",new Date().toISOString()).or("requires_verification.is.null,requires_verification.eq.false").order("scheduled_for",{ascending:!0});if(n)throw n;return a},async getById(a,n){let t=c.from("scheduled_emails").select(`
        *,
        account:accounts(*),
        template:email_templates(*),
        automation:automations(id, name)
      `).eq("id",n);t=d(t,a);const{data:e,error:o}=await t.single();if(o)throw o;return e},async create(a,n){const t=g(a),{data:e,error:o}=await c.from("scheduled_emails").insert({owner_id:t,status:"Pending",...n}).select().single();if(o)throw o;return e},async createBatch(a,n){const t=g(a),e=n.map(s=>({owner_id:t,status:"Pending",...s})),{data:o,error:i}=await c.from("scheduled_emails").insert(e).select();if(i)throw i;return o},async update(a,n,t){let e=c.from("scheduled_emails").update({...t,updated_at:new Date().toISOString()}).eq("id",n);e=d(e,a);const{data:o,error:i}=await e.select().single();if(i)throw i;return o},async cancel(a,n){return this.update(a,n,{status:"Cancelled"})},async reschedule(a,n,t){return this.update(a,n,{scheduled_for:t,status:"Pending",attempts:0})},async markProcessing(a){const{data:n,error:t}=await c.from("scheduled_emails").update({status:"Processing",last_attempt_at:new Date().toISOString(),attempts:c.sql`attempts + 1`,updated_at:new Date().toISOString()}).eq("id",a).select().single();if(t)throw t;return n},async markSent(a,n){const{data:t,error:e}=await c.from("scheduled_emails").update({status:"Sent",email_log_id:n,updated_at:new Date().toISOString()}).eq("id",a).select().single();if(e)throw e;return t},async markFailed(a,n){const{data:t,error:e}=await c.from("scheduled_emails").select("attempts, max_attempts").eq("id",a).single();if(e)throw e;const o=t.attempts<t.max_attempts,{data:i,error:s}=await c.from("scheduled_emails").update({status:o?"Pending":"Failed",error_message:n,updated_at:new Date().toISOString()}).eq("id",a).select().single();if(s)throw s;return i},async markSkipped(a,n){const{data:t,error:e}=await c.from("scheduled_emails").update({status:"Cancelled",error_message:n,updated_at:new Date().toISOString()}).eq("id",a).select().single();if(e)throw e;return t},async wasRecentlySent(a,n,t=7){if(!a||!n)return!1;const e=new Date;e.setDate(e.getDate()-t);const{data:o,error:i}=await c.from("email_logs").select("id").eq("template_id",a).ilike("to_email",n.trim()).gte("sent_at",e.toISOString()).in("status",["Sent","Delivered","Opened","Clicked"]).limit(1);return i?(console.warn("Failed to check recent sends:",i),!1):o&&o.length>0},async getReadyToSendFiltered(){var e,o;const a=await this.getReadyToSend();if(!a||a.length===0)return{eligible:[],skipped:[]};const n=[],t=[];for(const i of a){const s=i.recipient_email||((e=i.account)==null?void 0:e.person_email)||((o=i.account)==null?void 0:o.email);if(i.template_id&&s&&await this.wasRecentlySent(i.template_id,s)){await this.markSkipped(i.id,"Template already sent to this recipient within 7 days"),t.push(i);continue}n.push(i)}return{eligible:n,skipped:t}},async delete(a,n){let t=c.from("scheduled_emails").delete().eq("id",n);t=d(t,a);const{error:e}=await t;if(e)throw e;return!0},async getStats(a){let n=c.from("scheduled_emails").select("status, scheduled_for");n=d(n,a);const{data:t,error:e}=await n;if(e)throw e;const o=new Date,i={pending:0,processing:0,sent:0,failed:0,cancelled:0,upcomingToday:0,upcomingThisWeek:0},s=new Date(o);s.setHours(23,59,59,999);const r=new Date(o);return r.setDate(r.getDate()+7),t.forEach(l=>{if(i[l.status.toLowerCase()]++,l.status==="Pending"){const u=new Date(l.scheduled_for);u<=s&&i.upcomingToday++,u<=r&&i.upcomingThisWeek++}}),i}},w={async getDashboardData(a,n={}){const{days:t=30}=n,[e,o,i,s,r,l,u]=await Promise.all([y.getComparisonStats(a,t),q.getRecent(a,{limit:10}),S.getUpcoming(a,5),y.getRecentOpens(a,5),y.getRecentClicks(a,5),f.getCounts(a),this.getAutomationStats(a)]);return{emailStats:e.current,emailChanges:e.changes,recentActivity:o,scheduledEmails:i,recentOpens:s,recentClicks:r,accountCounts:l,automationStats:u}},async getAutomationStats(a){let n=c.from("automations").select(`
        id,
        name,
        status,
        stats
      `).eq("status","Active");n=d(n,a);const{data:t,error:e}=await n;if(e)throw e;const o=t.map(l=>l.id),{data:i,error:s}=await c.from("automation_enrollments").select("automation_id, status").in("automation_id",o);if(s)throw s;const r={};return i.forEach(l=>{r[l.automation_id]||(r[l.automation_id]={active:0,total:0}),r[l.automation_id].total++,l.status==="Active"&&r[l.automation_id].active++}),{total:t.length,active:t.filter(l=>l.status==="Active").length,automations:t.map(l=>{var u,m;return{...l,enrollmentCount:((u=r[l.id])==null?void 0:u.total)||0,activeEnrollments:((m=r[l.id])==null?void 0:m.active)||0}})}},async getEmailPerformanceOverTime(a,n=30){const t=new Date;t.setDate(t.getDate()-n);let e=c.from("email_stats_daily").select("*").is("automation_id",null).gte("stat_date",t.toISOString().split("T")[0]).order("stat_date");e=d(e,a);const{data:o,error:i}=await e;if(i)throw i;return o},async getTopAutomations(a,n=5){let t=c.from("automations").select("id, name, stats").eq("status","Active");t=d(t,a);const{data:e,error:o}=await t;if(o)throw o;return e.map(s=>{var r,l,u,m,_;return{...s,sent:((r=s.stats)==null?void 0:r.sent)||0,opened:((l=s.stats)==null?void 0:l.opened)||0,clicked:((u=s.stats)==null?void 0:u.clicked)||0,openRate:((m=s.stats)==null?void 0:m.sent)>0?(((_=s.stats)==null?void 0:_.opened)||0)/s.stats.sent*100:0}}).sort((s,r)=>r.openRate-s.openRate).slice(0,n)},async getAccountsNeedingAttention(a){let n=c.from("email_logs").select(`
        account:accounts(account_unique_id, name, person_email)
      `).eq("status","Bounced").not("account_id","is",null).limit(10);n=d(n,a);const{data:t,error:e}=await n;if(e)throw e;const o=await f.getWithExpiringPolicies(a,30);return{bouncedEmails:t.map(i=>i.account).filter((i,s,r)=>r.findIndex(l=>l.account_unique_id===i.account_unique_id)===s),expiringPolicies:o.slice(0,10)}},async getQuickStats(a){const n=new Date().toISOString().split("T")[0],t=new Date;t.setDate(t.getDate()-30);let e=c.from("email_logs").select("*",{count:"exact",head:!0}).gte("sent_at",n);e=d(e,a);let o=c.from("email_logs").select("*",{count:"exact",head:!0}).gte("first_opened_at",n);o=d(o,a);let i=c.from("automations").select("*",{count:"exact",head:!0}).eq("status","Active");i=d(i,a);let s=c.from("scheduled_emails").select("*",{count:"exact",head:!0}).eq("status","Pending");s=d(s,a);const[{count:r},{count:l},{count:u},{count:m}]=await Promise.all([e,o,i,s]);return{emailsToday:r||0,opensToday:l||0,activeAutomations:u||0,pendingScheduled:m||0}}};function O(){const{ownerIds:a,filterKey:n}=h();return p({queryKey:["dashboard",n,"quick"],queryFn:()=>w.getQuickStats(a),enabled:a.length>0,staleTime:1e4,refetchInterval:3e4})}function T(a=30){const{ownerIds:n,filterKey:t}=h();return p({queryKey:["dashboard",t,"performance",a],queryFn:()=>w.getEmailPerformanceOverTime(n,a),enabled:n.length>0})}export{T as a,q as b,y as e,S as s,O as u};
