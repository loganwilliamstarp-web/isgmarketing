import{s as l}from"./index-laD0T8Yw.js";import{a as m,n as $}from"./useEffectiveOwner-BN9vJCNM.js";const P={async getAll(t,e={}){const{status:o,search:i,limit:r=25,offset:n=0,expiring:c=!1}=e;let a=l.from("accounts").select("*",{count:"exact",head:!0});if(a=m(a,t),o){let _=o;o.toLowerCase()==="prior"&&(_="prior_customer"),a=a.ilike("account_status",_)}i&&(a=a.or(`name.ilike.%${i}%,person_email.ilike.%${i}%,email.ilike.%${i}%`));const{count:d,error:u}=await a;if(u)throw u;let p=l.from("accounts").select("*").order("name").range(n,n+r-1);if(p=m(p,t),o){let _=o;o.toLowerCase()==="prior"&&(_="prior_customer"),p=p.ilike("account_status",_)}i&&(p=p.or(`name.ilike.%${i}%,person_email.ilike.%${i}%,email.ilike.%${i}%`));const{data:f,error:S}=await p;if(S)throw S;if(!f||f.length===0)return{accounts:[],total:d||0};const q=f.map(_=>_.account_unique_id).filter(Boolean),C=new Date().toISOString().split("T")[0],w=new Date;w.setDate(w.getDate()+30);const k=w.toISOString().split("T")[0];if(q.length>0){const{data:_,error:g}=await l.from("policies").select("account_id, policy_lob, policy_status, expiration_date").in("account_id",q);if(!g&&_){const y={};_.forEach(s=>{var x;y[s.account_id]||(y[s.account_id]=[]);const h=s.expiration_date&&s.expiration_date>=C&&s.expiration_date<=k;y[s.account_id].push({policy_type:s.policy_lob,status:((x=s.policy_status)==null?void 0:x.toLowerCase())||"unknown",expiration_date:s.expiration_date,is_expiring:h})}),f.forEach(s=>{s.policies=y[s.account_unique_id]||[],s.policy_count=s.policies.length,s.has_expiring_policy=s.policies.some(h=>h.is_expiring),s.expiring_policy_count=s.policies.filter(h=>h.is_expiring).length})}}if(c){const _=f.filter(g=>g.has_expiring_policy);return{accounts:_,total:_.length,isExpiringFilter:!0}}return{accounts:f,total:d||0}},async getStats(t){let e=l.from("accounts").select("*",{count:"exact",head:!0});e=m(e,t);const{count:o,error:i}=await e;if(i)throw i;let r=l.from("accounts").select("*",{count:"exact",head:!0}).ilike("account_status","customer");r=m(r,t);const{count:n}=await r;let c=l.from("accounts").select("*",{count:"exact",head:!0}).ilike("account_status","prospect");c=m(c,t);const{count:a}=await c;let d=l.from("accounts").select("*",{count:"exact",head:!0}).ilike("account_status","prior_customer");d=m(d,t);const{count:u}=await d;let p=l.from("accounts").select("*",{count:"exact",head:!0}).ilike("account_status","lead");p=m(p,t);const{count:f}=await p;let S=0;const q=new Date().toISOString().split("T")[0],E=new Date;E.setDate(E.getDate()+30);const C=E.toISOString().split("T")[0],{count:w}=await l.from("policies").select("*",{count:"exact",head:!0}).gte("expiration_date",q).lte("expiration_date",C);if(w&&w>0){const{data:k}=await l.from("policies").select("account_id").gte("expiration_date",q).lte("expiration_date",C).limit(5e3);if(k&&k.length>0){const _=[...new Set(k.map(g=>g.account_id).filter(Boolean))];if(_.length>0){let g=0;const y=100;for(let s=0;s<_.length;s+=y){const h=_.slice(s,s+y);let x=l.from("accounts").select("*",{count:"exact",head:!0}).in("account_unique_id",h);x=m(x,t);const{count:D}=await x;g+=D||0}S=g}}}return{Customer:n||0,Prospect:a||0,Prior:u||0,Lead:f||0,total:o||0,expiring:S}},async getById(t){const{data:e,error:o}=await l.from("accounts").select("*").eq("account_unique_id",t).single();if(o)throw o;return e},async getByIdWithPolicies(t){const{data:e,error:o}=await l.from("accounts").select("*").eq("account_unique_id",t).single();if(o)throw o;if(!e)return null;const{data:i,error:r}=await l.from("policies").select("*").eq("account_id",t).order("expiration_date",{ascending:!1});if(r)return console.error("Error fetching policies:",r),{...e,policies:[]};if(i&&i.length>0){const n=[...new Set(i.map(c=>c.carrier_id).filter(Boolean))];if(n.length>0){const{data:c,error:a}=await l.from("carriers").select("id, name").in("id",n);if(c&&c.length>0){const d={};c.forEach(u=>{d[u.id]=u.name}),i.forEach(u=>{u.carrier_id&&d[u.carrier_id]&&(u.carrier={name:d[u.carrier_id]})})}}}return{...e,policies:i||[]}},async getByIdWithEmailHistory(t,e){const o=await this.getByIdWithPolicies(e);let i=l.from("email_logs").select(`
        *,
        template:email_templates(id, name),
        automation:automations(id, name)
      `).eq("account_id",e).order("created_at",{ascending:!1}).limit(20);i=m(i,t);const{data:r,error:n}=await i;if(n)throw n;const{data:c,error:a}=await l.from("automation_enrollments").select(`
        *,
        automation:automations(id, name, category)
      `).eq("account_id",e).order("enrolled_at",{ascending:!1});if(a)throw a;return{...o,emailLogs:r,enrollments:c}},async search(t,e,o=20){let i=l.from("accounts").select("account_unique_id, name, person_email, email, account_status, primary_contact_first_name, primary_contact_last_name").or(`name.ilike.%${e}%,person_email.ilike.%${e}%,email.ilike.%${e}%,primary_contact_first_name.ilike.%${e}%,primary_contact_last_name.ilike.%${e}%`).limit(o);i=m(i,t);const{data:r,error:n}=await i;if(n)throw n;return r},async getByStatus(t,e,o={}){const{limit:i=50,offset:r=0}=o;let n=l.from("accounts").select("*").eq("account_status",e).order("name").range(r,r+i-1);n=m(n,t);const{data:c,error:a}=await n;if(a)throw a;return c},async getCustomers(t,e={}){return this.getByStatus(t,"customer",e)},async getProspects(t,e={}){return this.getByStatus(t,"prospect",e)},async getPriorCustomers(t,e={}){return this.getByStatus(t,"prior_customer",e)},async getWithExpiringPolicies(t,e=45){const o=new Date;o.setDate(o.getDate()+e);const i=$(t),{data:r,error:n}=await l.from("policies").select(`
        policy_unique_id,
        policy_lob,
        expiration_date,
        policy_status,
        account_id,
        account:accounts!policies_account_id_fkey(
          account_unique_id,
          name,
          person_email,
          email,
          owner_id,
          primary_contact_first_name,
          primary_contact_last_name
        )
      `).eq("policy_status","Active").lte("expiration_date",o.toISOString().split("T")[0]).gte("expiration_date",new Date().toISOString().split("T")[0]).order("expiration_date");if(n)throw n;return r.filter(c=>{var a;return((a=c.account)==null?void 0:a.owner_id)&&i.includes(c.account.owner_id)})},async getCounts(t){let e=l.from("accounts").select("account_status");e=m(e,t);const{data:o,error:i}=await e;if(i)throw i;const r={total:o.length,customer:0,prospect:0,prior_customer:0,other:0};return o.forEach(n=>{var a;const c=((a=n.account_status)==null?void 0:a.toLowerCase().replace(" ","_"))||"other";r[c]!==void 0?r[c]++:r.other++}),r},getEmail(t){return t.person_email||t.email},getDisplayName(t){return t.primary_contact_first_name?`${t.primary_contact_first_name} ${t.primary_contact_last_name||""}`.trim():t.name},canReceiveMarketing(t){return t.user_subscribed_to_marketing!==!1&&t.person_has_opted_out_of_email!==!0&&(t.person_email||t.email)},async getEligibleForAutomation(t,e){let o=l.from("accounts").select("*").or("person_has_opted_out_of_email.is.null,person_has_opted_out_of_email.eq.false").not("person_email","is",null);o=m(o,t);const{data:i,error:r}=await o;if(r)throw r;const n=i.map(u=>u.account_unique_id),{data:c,error:a}=await l.from("policies").select("*").in("account_id",n);if(a)throw a;return i.map(u=>({...u,policies:c.filter(p=>p.account_id===u.account_unique_id)})).filter(u=>this.canReceiveMarketing(u))}};export{P as a};
